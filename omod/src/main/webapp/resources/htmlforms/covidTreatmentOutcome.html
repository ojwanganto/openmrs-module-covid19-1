<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http://license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->
  <htmlform>
	<script type="text/javascript">

        var tranferredOutConcept = 159492;
        var referredConcept = 164165;
        var dischargedConcept = 1692;
		jq(document).ready(function(){
            getField('discReason.value').change(fillDetails);

		});

        function fillDetails() {
            var discontReason = getValue('discReason.value');
            if (discontReason == tranferredOutConcept) {
                jq('#transferred').show();
                jq('#referred').hide();
                jq('#discharged').hide();
                clearSections(jq('#referred'));
                clearSections(jq('#discharged'));
            } else if (discontReason == referredConcept) {
                jq('#transferred').hide();
                jq('#referred').show();
                jq('#discharged').hide();
                clearSections(jq('#transferred'));
                clearSections(jq('#discharged'));
            } else if (discontReason == dischargedConcept) {
                jq('#transferred').hide();
                jq('#referred').hide();
                jq('#discharged').show();
                clearSections(jq('#referred'));
                clearSections(jq('#transferred'));
            } else {
                jq('#transferred').hide();
                jq('#referred').hide();
                jq('#discharged').hide();
                clearSections(jq('#referred'));
                clearSections(jq('#discharged'));
                clearSections(jq('#transferred'));
			}

        }

        //Clear hidden sections
        clearSections = function(parentObj) {
            parentObj.find('input[type=radio]').each(function() {
                this.checked = false;
            });
            parentObj.find('input[type=checkbox]').each(function() {
                this.checked = false;
            });
            parentObj.find('input[type=text]').each(function() {
                jq(this).val("");
            });
            parentObj.find('select').each(function() {
                this.selectedIndex =0;
            });
        }

        beforeSubmit.push(function() {
            //Before submit validations
            pAge = parseInt('<lookup expression="patient.age"/>');
            var encounterDate = getValue('encounter-date.value'); 
            var discontinuationReason = jq("#discReason select").val();
            var transferFacility = jq('#facility-transferred-to input[type=text]').val();
            var hospitalReferred = jq('#facility-referred-to input[type=text]').val();
            
                if( discontinuationReason == 164165 &amp;&amp; hospitalReferred == '' ) { // referral
                    getField('facility-referred-to.error').html('Please specify hospital referred to').show();
                    return false
                }

                if( discontinuationReason == 159492 &amp;&amp; transferFacility == '' ) { // transfer
                    getField('facility-transferred-to.error').html('Please specify hospital transferred to').show();
                    return false
                }

            return true;
        });
	</script>



	<div class="ke-form-header">
		<ifMode mode="EDIT">
			<script type="text/javascript">
                jq(function(){
                    showHideReferralDetails();
                    showHideTransferredOutDetails();
                    showHideDischargedDetails();
                });

                function showHideReferralDetails() {
                    if (getValue('discReason.value') == 164165) {
                        jq('#referred').show();
                    }else{
                        jq('#referred').hide();
                    }
                }

                function showHideTransferredOutDetails() {
                    if (getValue('obs-other-symptom.value') == 159492) {
                        jq('#transferred').show();
                    }else{
                        jq('#transferred').hide();
                    }
                }

                function showHideDischargedDetails() {
                    if (getValue('obs-other-symptom.value') == 1692) {
                        jq('#discharged').show();
                    }else{
                        jq('#discharged').hide();
                    }
                }
			</script>
		</ifMode>
		<table width="100%">
			<tr>
				<td align="left">Date: <encounterDate id="encounter-date" showTime="true" /></td>
                <td>Enrolled by: <encounterProvider default="currentUser" /></td>
				<td>Enrolled at: <encounterLocation default="GlobalProperty:kenyaemr.defaultLocation" /></td>

			</tr>
		</table>
	</div>
	<div class="ke-form-content">
		<fieldset>
			<legend>COVID-19 Treatment Discontinuation</legend>
			<table>
                <includeIf velocityTest="$covid19.lastDocumentedIsolationLocation() == 'home_isolation'">
                    <tr id="home-isolation">
                        <td>Reason for discontinuation:</td>
                        <td><obs required="true" id="discReason" conceptId="161555AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                answerConceptIds="1663AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,164165AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,160034AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,160018AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                answerLabels="Completed isolation,Referral,Died,Never reached" style="dropdown" labelText=""  showDate="false"/></td>

                    </tr>
                </includeIf>
                <includeIf velocityTest="$covid19.lastDocumentedIsolationLocation() == 'hospital_isolation'">
                    <tr id="hospital-isolation">
                        <td>Reason for discontinuation:</td>
                        <td><obs required="true" id="discReason" conceptId="161555AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                answerConceptIds="159492AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,1692AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,160034AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                answerLabels="Transferred to another hospital, Discharged,Died" style="dropdown" labelText=""  showDate="false"/></td>

                    </tr>
                </includeIf>
				<tr></tr>
				<tr id="transferred" style="display: none">
					<td>Transfer to Facility:</td>
					<td ><obs id="facility-transferred-to" conceptId="159495AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" labelText=" "/></td>
					<td></td>
					<td></td>
				</tr>

				<tr id="referred" style="display: none">
					<td>Facility referred to:</td>
					<td><obs id="facility-referred-to" conceptId="161562AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" labelText=" " /></td>
				</tr>

				<tr></tr>
				<tr></tr>
				<tr>
					<td>Comments:</td>
					<td ><obs conceptId="160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" rows="5" cols="50"/></td>
				</tr>
			</table>
		</fieldset>

	</div>

	<completeProgram programId="117093ea-5355-11ec-bf63-0242ac130002" />

	<div class="ke-form-footer">
		<submit />
	</div>

</htmlform>